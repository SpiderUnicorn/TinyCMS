<html>
<style>
	.ball {
		background-color: red;
		width: 100px;
		height: 100px;
		border-radius: 50px;
		position: absolute;
		transition: background-color 0.1s ease;
	}

	.beer {
		width: 200px;
		font-size: 30px;
		color: #fff;
		text-align: center;
		line-height: 100px;
		transition: all 0.3s ease;
	}
</style>

<body>
	<div class="ball beer">BEER</div>
	<div class="ball">&nbsp;</div>
	<div class="ball">&nbsp;</div>
	<div class="ball">&nbsp;</div>
	<div class="ball">&nbsp;</div>
	<div id="poopcnt">
		<video id="webCamWindow" style="width:160px;height:100px" autoplay></video>
		<canvas id="test" style="width:160px;height:100px">

		</canvas>
	</div>

	<script>
		var webCamWindow = document.getElementById('webCamWindow');
		var canvas = document.createElement('canvas');
		var ctx = canvas.getContext('2d');
		var width = 160;
		var height = 100;
		var minDiff = 12;
		var objT = 20;
		var mtx = [];

		function clear() {
			mtx = [];
			for (var y = 0; y < (height / 10); y++) {
				var xa = [];
				mtx.push(xa);
				for (var x = 0; x < (width / 10); x++) {
					xa.push(0);
				}
			}
		}

		function toRadians(angle) {
			return angle * (Math.PI / 180);
		}

		var balls = [];

		var ballCls = function (elm) {
			this.elm = elm;
			this.speedX = (Math.random() * 4) - 2;
			this.speedY = (Math.random() * 4) - 2;
			this.hitCount = 0;
			this.hitTemp = 0;
			this.angle = Math.random() * 360;
			this.x = Math.random() * document.body.offsetWidth;
			this.y = Math.random() * document.body.offsetHeight;
		}

		ballCls.prototype.pos = function () {
			var pos = this.elm.getBoundingClientRect();
			return [Math.floor(pos.y / yFactor), 16 - Math.floor(pos.x / xFactor)]
		}

		ballCls.prototype.hit = function (angdist) {
			this.angle = angdist[0] - 90;

			this.speed = 12 - angdist[1];
			if (angdist[1] < 2) {
				this.hitTemp = 30;
			}
		}

		ballCls.prototype.move = function () {
			var st = this.elm.style;

			// var r = toRadians(this.angle);
			// var moveX = Math.sin(r) * this.speed;
			// var moveY = Math.cos(r) * this.speed;


			this.x += this.speedX;
			this.y += this.speedY;

			if (this.x > document.body.offsetWidth - 100)
				this.speedX = -this.speedX;
			if (this.y > document.body.offsetHeight - 100)
				this.speedY = -this.speedY;
			if (this.x < 0)
				this.speedX = -this.speedX;
			if (this.y < 0)
				this.speedY = -this.speedY;
			st.left = Math.round(this.x) + 'px';
			st.top = Math.round(this.y) + 'px';
			if (this.hitTemp > 0) {
				this.hitTemp--;
				st.backgroundColor = 'blue';
			}
			else st.backgroundColor = 'red';
		}

		var ballElms = document.querySelectorAll('.ball');
		for (var i = 0; i < ballElms.length; i++) {
			balls.push(new ballCls(ballElms[i]));
		}

		function moveBalls() {
			balls.map(function (b) {
				b.move();
			});
			window.requestAnimationFrame(moveBalls);
		}

		window.requestAnimationFrame(moveBalls);

		var lastData;

		canvas.width = width;
		canvas.height = height;

		var xFactor = document.body.offsetWidth / 16;
		var yFactor = document.body.offsetHeight / 10;

		function plotChanges(diff) {
			clear();
			var maxVal = 0;
			var maxPos = [];
			var pos = diff.map(function (val) {
				var y = Math.floor((val / width) / 10);
				var x = Math.floor((val % width) / 10);
				mtx[y][x]++;
				maxVal = Math.max(maxVal, mtx[y][x]);
				if (mtx[y][x] == maxVal) {
					maxPos = [y, x];
				}
			});

			function mapClose(y, x, ret) {

				function hasYX(i, j) {
					var ok = false;
					ret.map(function (v) {
						if (v[0] == i && v[1] == j)
							ok = true;
					});
					return ok;
				}
				function checkAdd(i, j) {
					if (!hasYX(i, j)) {
						//console.log(i,j);
						//debugger;

						if (mtx[i][j] > objT) {
							mtx[i][j] = 0;
							ret.push([i, j]);
							mapClose(i, j, ret);
						}

					}
				}
				if (x > 1 && x < 15 && y > 0 && y < 10) {
					if (y > 1) {
						checkAdd(y - 1, x - 1);
						checkAdd(y - 1, x);
						checkAdd(y - 1, x + 1);
					}
					checkAdd(y, x - 1);
					checkAdd(y, x + 1);
					if (y < 9) {
						checkAdd(y + 1, x - 1);
						checkAdd(y + 1, x);
						checkAdd(y + 1, x + 1);
					}
				}
				return ret;
			}

			function parseObject(y, x) {
				var obj = {
					start: [y, x],
					totalPoints: 1,
					pos: [[y, x]]
				};
				obj.pos = mapClose(y, x, obj.pos);

				return obj.pos;
			}

			var found = [];

			//console.log(mtx);

			function findObject() {
				for (var y = 0; y < (height / 10); y++) {
					for (var x = 0; x < (width / 10); x++) {
						if (mtx[y][x] > objT) {
							found.push(parseObject(x, y));
						}
					}
				}
			}
			if (maxVal > 30) {
				findObject();
				var r = [];
				found.map(function (v) {
					if (v.length > 30)
						r.push(v);
				});
				console.log(r);
				var c = document.getElementById("test");
				var ctx = c.getContext("2d");
				if (r.length) {
					ctx.clearRect(0, 0, 160, 100);

					r.map(function (o) {
						
						o.map(function (p) {
							ctx.rect(p[1] * 10, p[0] * 10,10,10);
							ctx.stroke();
						});
						

					});
				}
			}

			function findClose(p) {

				var angle = Math.atan2(maxPos[0] - p[0], maxPos[1] - p[1]) * 180 / Math.PI;
				var a = p[0] - maxPos[0];
				var b = p[1] - maxPos[1];
				var distance = Math.sqrt(a * a + b * b);

				return [angle, distance];
			}

			if (maxVal > 50) {
				for (var i = 0; i < balls.length; i++) {
					var elm = balls[i];
					var np = elm.pos();

					var v = findClose(np);


					if (i == 0) {
						elm.speedX = 0;
						elm.speedY = 0;
						elm.y = maxPos[0] * yFactor;
						elm.x = (16 - maxPos[1]) * xFactor;
					}
					else {
						elm.hit(v);
					}

				}

			}
		}

		function compareImages() {
			var newData = flatten(captureImage());

			var changed = [];
			if (lastData) {
				for (var i = 0; i < newData.length; i++) {
					var diff = Math.abs(newData[i] - lastData[i]);
					if (diff > minDiff) {
						changed.push(i);
					}
				}
				if (changed.length > 30) {
					plotChanges(changed);
				}
			}
			lastData = newData;

		}

		function flatten(arr) {
			var ret = [];
			for (var i = 0; i < (64000 / 4); i++) {
				var j = i * 4;
				//arr[j] + 
				ret.push((arr[j + 1] + arr[j + 2]) / 2);
			}
			return ret;
		}

		function captureImage() {
			ctx.drawImage(webCamWindow, 0, 0, width, height);
			return ctx.getImageData(0, 0, width, height).data;
		}

		(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia).call(
			navigator,
			{ video: true },
			function (localMediaStream) {
				if (webCamWindow) {
					var vendorURL = window.URL || window.webkitURL;

					if (navigator.mozGetUserMedia) {
						webCamWindow.mozSrcObject = localMediaStream;
						webCamWindow.play();
					} else {
						webCamWindow.src = vendorURL.createObjectURL(localMediaStream);
					}
					setInterval(compareImages, 40);
				}
			},
			console.error
		);

	</script>
</body>

</html>