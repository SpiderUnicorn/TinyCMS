// moddade den lite
<html>
<style>
	.ball {
		background-color: red;
		width: 50px;
		height: 50px;
		border-radius: 50px;
		position: absolute;
		transition: background-color 0.1s ease;
	}
	.beer {
		width:200px;
		font-size: 30px;
		color:#fff;
		text-align: center;
		line-height:100px;
		/* transition: all 0.3s ease; */
	}
	.mrk {
		width:50px;
		height:50px;
		position: absolute;
        background-color: #f0f;
	}
</style>

<body>
	<div class="mrk"></div>
	<div class="ball beer">BEER</div>
	<div class="ball">&nbsp;</div>
	<div class="ball">&nbsp;</div>
	<div class="ball">&nbsp;</div>
	<div class="ball">&nbsp;</div>
	<video id="webCamWindow" style="width:160px;height:100px" autoplay></video>

	<script>
		var webCamWindow = document.getElementById('webCamWindow');
		var canvas = document.createElement('canvas');
		var ctx = canvas.getContext('2d');
		var width = 160;
		var height = 100;
		var minDiff = 12;
		var mtx = [];

		function clear() {
			mtx = [];
			for (var y = 0; y < (height / 10); y++) {
				var xa = [];
				mtx.push(xa);
				for (var x = 0; x < (width / 10); x++) {
					xa.push(0);
				}
			}
		}

		var balls = [];

		var ballCls = function (elm) {
			this.elm = elm;
			this.speed = Math.random() * 3;
			this.hitCount = 0;
			this.hitTemp = 0;
			this.angle = Math.random() * 360;
            this.vx = 0; // current velocity
            this.vy = 0;
            this.tvx = 0; // target velocity
            this.tvy = 0;
            this.fx = 0; // force
            this.fy = 0;
			this.x = Math.random() * document.body.offsetWidth;
			this.y = Math.random() * document.body.offsetHeight;
		}

		ballCls.prototype.pos = function () {
			var pos = this.elm.getBoundingClientRect();
			return [(pos.y / yFactor), (pos.x / xFactor)]
		}

		ballCls.prototype.hit = function (angdist) {
			console.log(angdist);
			this.angle = angdist[0];
			this.speed = 12-angdist[1];
			if (angdist[1]<2) {
				this.hitTemp = 30;
			}
			/*if (this.hitTemp < 1) {
				this.hitCount++;
				this.hitTemp = val / 2;
				this.angle += 180;
			}*/
		}

		ballCls.prototype.move = function () {
			var st = this.elm.style;

			// var r = toRadians(this.angle);
			// var moveX = Math.sin(r) * this.speed;
			// var moveY = Math.cos(r) * this.speed;


			// this.x += moveX;
			// this.y += moveY;

            const DELTA = 60.0; // fps
            const friction = 0.5;
            const drag = 0.4;
            const influence = 0.4;

            this.vx += (this.tvx - this.vx) * influence / DELTA;
            this.vy += (this.tvy - this.vy) * influence / DELTA;

            // this.fx -= friction * this.fx / DELTA;
            // this.fy -= friction * this.fy / DELTA;

            // this.vx += this.fx / DELTA;
            // this.vy += this.fy / DELTA;

            // this.vx -= drag * this.vx / DELTA;
            // this.vy -= drag * this.vy / DELTA;

            this.x += this.vx / DELTA;
            this.y += this.vy / DELTA;

            if (this.x < 0) {
				this.x = 0;
                this.vx = Math.abs(this.vx);
            }

            if (this.y < 0) {
				this.y = 0;
                this.vy = Math.abs(this.vy);
            }

			if (this.x > document.body.offsetWidth) {
				this.x = document.body.offsetWidth;
                this.vx = -Math.abs(this.vx);
            }

			if (this.y > document.body.offsetHeight) {
				this.y = document.body.offsetHeight;
                this.vy = -Math.abs(this.vy);
            }

			st.left = Math.round(this.x) + 'px';
			st.top = Math.round(this.y) + 'px';

			if (this.hitTemp > 0) {
				this.hitTemp--;
				st.backgroundColor = 'blue';
			}

			else st.backgroundColor = 'red';
		}

		var markerElms = document.querySelectorAll('.mrk');

		var ballElms = document.querySelectorAll('.ball');
		for (var i = 0; i < ballElms.length; i++) {
			balls.push(new ballCls(ballElms[i]));
		}

		function moveBalls() {
			balls.map(function (b) {
				b.move();
			});
			window.requestAnimationFrame(moveBalls);
		}

		window.requestAnimationFrame(moveBalls);

		var lastData;

		canvas.width = width;
		canvas.height = height;

		var xFactor = document.body.offsetWidth / 16;
		var yFactor = document.body.offsetHeight / 10;

		function plotChanges(diff) {
			clear();
			var maxVal = 0;
			var maxPos = [];
			var pos = diff.map(function (val) {
				var y = Math.floor((val / width) / 10);
				var x = Math.floor((val % width) / 10);
				mtx[y][x]++;
				maxVal = Math.max(maxVal, mtx[y][x]);
				if (mtx[y][x] == maxVal) {
					maxPos = [y, x];
				}
			});

            var mx = 0;
            var my = 0;
            if (maxVal > 50) {
                mx = maxPos[1] * xFactor;
                my = maxPos[0] * yFactor;
            }
            console.log('maxPos', maxPos, maxVal, mx, my);
            markerElms.forEach(elm => {
    			elm.style.left = Math.round(mx) + 'px';
	    		elm.style.top = Math.round(my) + 'px';
            });

			if (maxVal > 50) {
				for (var i = 0; i < balls.length; i++) {
					var elm = balls[i];
					var np = elm.pos();

                    var fx = maxPos[1] - np[1]
                    var fy = maxPos[0] - np[0]

                    var d = Math.sqrt(fx * fx + fy * fy);

                    fx /= d;
                    fy /= d;

                    elm.tvx = fx * 100;
                    elm.tvy = fy * 100;
				}
			}
		}

		function compareImages() {
			var newData = flatten(captureImage());

			var changed = [];
			if (lastData) {
				for (var i = 0; i < newData.length; i++) {
					var diff = Math.abs(newData[i] - lastData[i]);
					if (diff > minDiff) {
						changed.push(i);
					}
				}
				if (changed.length > 30) {
					plotChanges(changed);
				}
			}
			lastData = newData;

		}

		function flatten(arr) {
			var ret = [];
			for (var i = 0; i < (64000 / 4); i++) {
				var j = i * 4;
				ret.push((arr[j + 1] + arr[j + 2]) / 2);
			}
			return ret;
		}

		function captureImage() {
			ctx.drawImage(webCamWindow, 0, 0, width, height);
			return ctx.getImageData(0, 0, width, height).data;
		}

		(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia).call(
			navigator,
			{ video: true },
			function (localMediaStream) {
				if (webCamWindow) {
					var vendorURL = window.URL || window.webkitURL;

					if (navigator.mozGetUserMedia) {
						webCamWindow.mozSrcObject = localMediaStream;
						webCamWindow.play();
					} else {
						webCamWindow.src = vendorURL.createObjectURL(localMediaStream);
					}
					setInterval(compareImages, 40);
				}
			},
			console.error
		);

	</script>
</body>
</html>