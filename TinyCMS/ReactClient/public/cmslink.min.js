var _extends=Object.assign||function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(n[o]=t[o])}return n};!function(S){var T={};S.cmslink=T;T.createLink=function(n,e){var t=n.url,o=new WebSocket(t),r=function(){try{var n=localStorage.getItem("__nodes");if(n&&n.length)return JSON.parse(n)}catch(n){return console.log("load error"),{}}}()||{},c={},i=function(n){"function"==typeof e&&e(n)},a=function(n,e){var t=c[n];t&&t.forEach(function(n){n.stopped||n.callback(e)})},u=!1,s=void 0,f=500,l=function(){console.warn("requesting reconnect"),i({connected:u=!1,reconnecting:!0}),s&&clearTimeout(s),s=setTimeout(function(){o=null,o=new WebSocket(t),p()},f+=500)},d=function(n){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:200;i(_extends({},n,{connected:u})),setTimeout(function(){i({connected:u})},e)},p=function(){i({connecting:!0,connected:u}),o.onopen=function(n){f=500,i({connected:u=!0}),console.log("sending token",m),o.send("##"+m+"##"),o.send("?root"),h()},o.onerror=l,o.onclose=l,o.onmessage=function(n){var e;d({data:!0}),function e(n){var t=n.id,o=n.children;t&&(r[t]=n,a(t,n)),o&&o.map(function(n){return e(n)})}(JSON.parse(n.data)),e=r,localStorage.setItem("__nodes",JSON.stringify(e))}},g=[],h=function n(){if(g.length&&u){var e=g.shift();d({sending:!0}),o.send(e),n()}},v=function(n){g.push(n),h()},k={fakeNode:function(n){console.log("render temp node",n),a(n.id,_extends({},n,{__fake:!0}))},send:v,getById:function(n){v("?"+n)},listenTo:function(e,n){var t={id:e,stopped:!1,stop:function(){t.stopped=!0},resume:function(){t.stopped=!1},remove:function(){var n=c[e].indexOf(t);c[e].splice(n,1)},callback:n};return c[e]?c[e].push(t):c[e]=[t],r[e]?t.stopped||n(r[e]):v("?"+e),t}},m=T.getToken().token;return T.onAuthenticationChanged(function(n){n&&n.token&&(m=n.token),v("!!"+m+"!!")}),p(),S.currentLink=k},T.getCurrentLink=function(){return S.currentLink};var t="_cmsState",r=[],c={},n=localStorage.getItem(t);n&&n.length&&(c=JSON.parse(n)),T.sessionChanged=function(n){var e={stopped:!1,stop:function(){e.stopped=!0},resume:function(){e.stopped=!1},remove:function(){var n=r.indexOf(e);r.splice(n,1)},callback:n};return r.push(e),setTimeout(function(){n(c)},10),e};T.setSession=function(n){"function"==typeof n&&(n=n(c));var o,e=_extends({},c,n);c=o=e,r.forEach(function(n){var e=n.stopped,t=n.callback;e||t(o)}),localStorage.setItem(t,JSON.stringify(o))},T.schemaHelper={getSchema:function(n){return fetch("/api/schema/"+n+"/").then(function(n){return n.json()})},getAll:function(){return fetch("/api/schema/").then(function(n){return n.json()})}};var e=function(n){return console.log("handle user auth status",n),n&&n.token&&localStorage.setItem("currentUserToken",n.token),o(n.token),n};T.getToken=function(){var n=localStorage.getItem("currentUserToken");return o(n)};var o=function(n){var e={valid:!1};if(n&&n.length){var t=n.split("."),o=atob(t[0]),r=JSON.parse(o),c=atob(t[1]),i=JSON.parse(c);e={valid:i.exp>Date.now()/1e3,header:r,data:i,token:n}}return a(e),e},a=function(e){s!==e.valid&&(s=e.valid,i.map(function(n){return n(e)}))},i=[],u=!1,s=!1;T.onAuthenticationChanged=function(n){-1===i.indexOf(n)&&i.push(n),n(T.getToken()),u||(u=!0,setInterval(function(){T.hasValidToken()},36e5))},T.isAdmin=function(){return T.hasValidToken()},T.hasValidToken=function(){return T.getToken().valid},T.signInWithToken=function(n){return fetch("/api/signInWithToken/",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:n})}).then(function(n){return n.json()}).then(e)}}(window);